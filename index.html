<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Scrapy spider by EchoBaker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Scrapy spider</h1>
      <h2 class="project-tagline">A Directory Stored with Multiple Spiders</h2>
      <a href="https://github.com/EchoBaker/Scrapy_spider" class="btn">View on GitHub</a>
      <a href="https://github.com/EchoBaker/Scrapy_spider/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/EchoBaker/Scrapy_spider/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="spider-constructed-by-scrapy" class="anchor" href="#spider-constructed-by-scrapy" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a><strong>Spider Constructed by scrapy</strong>
</h1>

<h2>
<a id="1-create-your-spider-project" class="anchor" href="#1-create-your-spider-project" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>1. Create your Spider Project</h2>

<p>Open bash (linux) or cmd (Windows)</p>

<pre><code>$ active snakes # launch py2.7 env
</code></pre>

<p>Scrapy now can only work perfectly with python2.x, so we activate the env of python2.7.</p>

<pre><code>$ scrapy startproject xkcd
</code></pre>

<p>Thus, we 've already generated a Project named xkcd, we are going to make it more powerful.</p>

<pre><code>$ cd xkcd
</code></pre>

<p><strong>Note :</strong> you must change to xkcd dir, otherwise the project can't execute.</p>

<h2>
<a id="2-define-your-structured-data" class="anchor" href="#2-define-your-structured-data" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>2. Define your Structured Data</h2>

<p>Edit<code>.\items.py</code> to define fields of scraped items like this.</p>

<pre><code>import scrapy


class XkcdItem(scrapy.Item):

    # define the fields for your item here like:
    name = scrapy.Field()
    image_urls = scrapy.Field()
    desc = scrapy.Field()
    file_paths = scrapy.Field()
</code></pre>

<p>The example code define a structured data form like this:
</p>

<table>
<tr>
<td><b>name</b></td>
<td><b>owner</b></td>
<td><b>price</b></td>
</tr>
<tr>
<td>Coffee</td>
<td>John</td>
<td>$ 10</td>
</tr>
<tr>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
</table>

<p></p>

<p>Later, we will use well-defined XkcdItem class to instantiate items with scraped data in <code>xkcd_spider.py</code></p>

<h2>
<a id="3-create-your-spiders" class="anchor" href="#3-create-your-spiders" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>3. Create your Spiders</h2>

<p>Define the spiders' behavious to extract the data you wanted. A example to scrape all the link of images in XKCD.com</p>

<pre><code>import os
import scrapy
from xkcd.items import XkcdItem
from scrapy.spiders import Spider
from scrapy.http import Request


class XkcdSpider(scrapy.Spider):
    name = 'xkcd'
    allowed_domains = ["xkcd.com/"]
    start_urls = ["http://xkcd.com"] + ["http://xkcd.com/%d/" % num for num in xrange(1, 4)]

    def parse(self, response):

        # Code Here to instantiate item
        item = XkcdItem()
        item['name'] = response.css('div#comic &gt; img::attr("alt")').extract()
        item['image_urls'] = ["http:" + response.css('div#comic &gt; img::attr("src")').extract()[0]]
        item['desc'] = response.css('div#comic &gt; img::attr("title")').extract()

        yield item
</code></pre>

<p>Well Done! we 've had a spider to work for us for get wanted item filled with scraped data.</p>

<h2>
<a id="4-customize-file-pipelines-to-stroe-data" class="anchor" href="#4-customize-file-pipelines-to-stroe-data" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>4. Customize File Pipelines to Stroe Data</h2>

<ul>
<li>### FilesPipeline</li>
</ul>

<pre><code>def file_path(self, request, response=None, info=None):
      if re.search(r'\d', request.url):
          media_guid = re.search(r'\d+', request.url).group()
      else:
          media_guid = '0'
      return 'web/%s.html' % (media_guid)
</code></pre>

<ul>
<li>### ImagesPipeline</li>
</ul>

<pre><code>from scrapy.pipelines.images import ImagesPipeline
from scrapy.exceptions import DropItem


class XkcdImgPipeline(ImagesPipeline):
    def file_path(self, request, response=None, info=None,):
        image_guid = request.url.split('/')[-1]
        return 'images/%s' % (image_guid)

    def get_media_requests(self, item, info):
        for image_url in item['image_urls']:
            yield scrapy.Request(image_url)

    def item_completed(self, results, item, info):
        image_paths = [x['path'] for ok, x in results if ok]
        if not image_paths:
            raise DropItem("Item contains no images")
        item['image_paths'] = image_paths
        yield item
</code></pre>

<h2>
<a id="5-configure-setting-of-project" class="anchor" href="#5-configure-setting-of-project" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>5. Configure Setting of Project</h2>

<p><img class="emoji" title=":sunglasses:" alt=":sunglasses:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f60e.png" height="20" width="20" align="absmiddle"></p>

<p><code>$ scrapy crawl xkcd --logfile="xkcd_log.log" -o xkcd.json -t json</code></p>

<p><code>$ scrapy crawl xkcd -a end=10</code></p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/EchoBaker/Scrapy_spider">Scrapy spider</a> is maintained by <a href="https://github.com/EchoBaker">EchoBaker</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
